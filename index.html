<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stoc Farma Pro v7 - PWA</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f1f5f9; --border: #cbd5e1; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--primary); padding-bottom: 50px; }
        
        .top-bar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 1rem; }
        
        .container { padding: 10px; max-width: 1000px; margin: 0 auto; }
        
        .btn-group { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .btn { padding: 10px 15px; border-radius: 6px; border: 1px solid var(--border); background: white; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .btn-blue { background: var(--accent); color: white; border: none; }
        .btn-red { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
        
        .search { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; margin-bottom: 10px; display: block; box-sizing: border-box; }
        
        .card { background: white; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .scroll-table { overflow-x: auto; width: 100%; }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #e2e8f0; padding: 10px; text-align: left; font-size: 0.8rem; border-bottom: 2px solid #cbd5e1; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; }
        
        input.edit { width: 100%; padding: 5px; border: 1px solid transparent; background: transparent; font-size: 0.95rem; }
        input.edit:focus { background: #f8fafc; border-bottom: 2px solid var(--accent); outline: none; }
        
        .qty { width: 60px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; padding: 5px; font-weight: bold; }
        .expirat { background-color: #ffe4e6; }
    </style>
</head>
<body>

<div class="top-bar">
    <h1>STOC FARMA v7.0</h1>
    <button class="btn" onclick="toggleMode()" id="modeBtn">MOD INVENTAR</button>
</div>

<div class="container">
    <div class="btn-group">
        <button class="btn btn-blue" onclick="addProd()">+ PRODUS</button>
        <button class="btn" onclick="document.getElementById('fileXls').click()">üì• IMPORT</button>
        <button class="btn" onclick="doBackup()">üíæ BACKUP</button>
        <button class="btn" onclick="document.getElementById('fileJson').click()">üîÑ RESTORE</button>
        <button class="btn" style="color:#d97706" onclick="exportAudit()">üìã JURNAL</button>
        
        <input type="file" id="fileXls" style="display:none" accept=".xlsx,.xls" onchange="importExcel(event)">
        <input type="file" id="fileJson" style="display:none" accept=".json" onchange="restoreBackup(event)">
    </div>

    <input type="text" id="search" class="search" placeholder="CautƒÉ produs (Enter salveazƒÉ editarea)..." onkeyup="render()">

    <div class="card">
        <div class="scroll-table">
            <table>
                <thead id="tHead"></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Configurare BazƒÉ de Date
    let db;
    try {
        db = new Dexie("Farma_Final_PWA_V7");
        db.version(1).stores({
            produse: '++id, nume, cantitateInt, cantitateFrac, ambalaj, dataExpirare, ordine',
            jurnal: '++id, nume, info, data'
        });
    } catch (e) { alert("Eroare DB. Re√ÆncarcƒÉ pagina."); }

    let isInventory = false;

    async function render() {
        if (!db) return;
        const q = document.getElementById('search').value.toLowerCase();
        const tbody = document.getElementById('tBody');
        const thead = document.getElementById('tHead');
        
        let data = await db.produse.orderBy('ordine').reverse().toArray();
        if (q) data = data.filter(p => p.nume.toLowerCase().includes(q));

        if (isInventory) {
            thead.innerHTML = `<tr><th>Actiuni</th><th>Produs</th><th>Emb.</th><th>Numarat (I/F)</th><th>Expirare</th></tr>`;
        } else {
            thead.innerHTML = `<tr><th>Audit</th><th>Produs</th><th>Emb.</th><th>Stoc (I/F)</th><th>Expirare</th><th>Sterge</th></tr>`;
        }

        tbody.innerHTML = data.map(p => {
            const isExp = checkExp(p.dataExpirare);
            const rowClass = isExp ? 'expirat' : '';
            
            if (isInventory) {
                return `<tr class="${rowClass}">
                    <td><button class="btn" onclick="duplica(${p.id})">üìã</button></td>
                    <td><input class="edit" value="${p.nume}" onchange="upd(${p.id}, 'nume', this.value)" onkeydown="enterKey(event)"></td>
                    <td><input type="number" class="qty" value="${p.ambalaj}" onchange="upd(${p.id}, 'ambalaj', this.value)" onkeydown="enterKey(event)"></td>
                    <td>
                        <input type="number" class="qty" value="${p.cantitateInt}" onchange="upd(${p.id}, 'cantitateInt', this.value)" onkeydown="enterKey(event)">
                        <input type="number" class="qty" style="color:blue" value="${p.cantitateFrac}" onchange="upd(${p.id}, 'cantitateFrac', this.value)" onkeydown="enterKey(event)">
                    </td>
                    <td><input class="edit" value="${p.dataExpirare}" onkeyup="formatDate(this)" onchange="upd(${p.id}, 'dataExpirare', this.value)" onkeydown="enterKey(event)"></td>
                </tr>`;
            } else {
                return `<tr class="${rowClass}">
                    <td>
                        <button class="btn" onclick="audit(${p.id})">üëÅÔ∏è</button>
                        <button class="btn" onclick="duplica(${p.id})" style="font-size:0.8rem">üìã</button>
                    </td>
                    <td><input class="edit" style="font-weight:bold" value="${p.nume}" onchange="upd(${p.id}, 'nume', this.value)" onkeydown="enterKey(event)"></td>
                    <td><input type="number" class="qty" value="${p.ambalaj}" onchange="upd(${p.id}, 'ambalaj', this.value)" onkeydown="enterKey(event)"></td>
                    <td>
                        <input type="number" class="qty" value="${p.cantitateInt}" onchange="upd(${p.id}, 'cantitateInt', this.value)" onkeydown="enterKey(event)">
                        <input type="number" class="qty" style="color:blue" value="${p.cantitateFrac}" onchange="upd(${p.id}, 'cantitateFrac', this.value)" onkeydown="enterKey(event)">
                    </td>
                    <td><input class="edit" value="${p.dataExpirare}" onkeyup="formatDate(this)" onchange="upd(${p.id}, 'dataExpirare', this.value)" onkeydown="enterKey(event)"></td>
                    <td><button class="btn-red" onclick="del(${p.id})">X</button></td>
                </tr>`;
            }
        }).join('');
    }

    async function addProd() {
        await db.produse.add({ nume: "Produs Nou", cantitateInt: 0, cantitateFrac: 0, ambalaj: 10, dataExpirare: "", ordine: Date.now() });
        render();
    }

    async function upd(id, field, val) { await db.produse.update(id, { [field]: val }); }
    
    function enterKey(e) { if(e.key === 'Enter') e.target.blur(); }

    async function del(id) { if(confirm("Stergi?")) { await db.produse.delete(id); render(); } }

    async function duplica(id) {
        const p = await db.produse.get(id); delete p.id; p.ordine = Date.now();
        await db.produse.add(p); render();
    }

    async function audit(id) {
        const p = await db.produse.get(id);
        const sist = (parseInt(p.cantitateInt) * parseInt(p.ambalaj)) + parseInt(p.cantitateFrac);
        const input = prompt(`AUDIT: ${p.nume}\nSISTEM: ${sist}\nRAFT (unitati):`, sist);
        if (input !== null) {
            const raft = parseInt(input) || 0;
            const dif = raft - sist;
            if(confirm(`Sistem: ${sist}\nRaft: ${raft}\nDiferenta: ${dif}\n\nActualizam?`)) {
                await db.produse.update(id, { cantitateInt: Math.floor(raft / p.ambalaj), cantitateFrac: raft % p.ambalaj });
                await db.jurnal.add({ nume: p.nume, info: `S:${sist} R:${raft} D:${dif}`, data: new Date().toLocaleString() });
                render();
            }
        }
    }

    async function importExcel(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = new Uint8Array(ev.target.result);
                const wb = XLSX.read(data, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let count = 0;
                for(let row of json) {
                    const k = Object.keys(row);
                    const v = (kw) => row[k.find(key => key.toLowerCase().includes(kw))] || "";
                    await db.produse.add({
                        nume: String(v("nume") || v("prod") || v("denu") || "Fara Nume"),
                        cantitateInt: parseInt(v("stoc") || v("cant") || v("buc")) || 0,
                        cantitateFrac: 0,
                        ambalaj: parseInt(v("amb") || v("pack")) || 10,
                        dataExpirare: String(v("exp") || v("data") || ""),
                        ordine: Date.now() + count++
                    });
                }
                alert("Importat!"); render();
            } catch(e) { alert("Eroare fisier: " + e.message); }
        };
        reader.readAsArrayBuffer(file);
    }

    function toggleMode() { isInventory = !isInventory; document.getElementById('modeBtn').innerText = isInventory ? "INCHIDE INVENTAR" : "MOD INVENTAR"; render(); }
    function checkExp(d) { if(!d || d.length < 6) return false; const p = d.replace(/\D/g, '').match(/.{1,2}/g); if(!p||p.length<3)return false; return new Date("20"+p[2],p[1]-1,p[0]) < new Date(); }
    function formatDate(i) { let v = i.value.replace(/\D/g, ''); if(v.length > 2) v = v.slice(0, 2) + '/' + v.slice(2); if(v.length > 5) v = v.slice(0, 5) + '/' + v.slice(5, 7); i.value = v; }
    
    async function exportAudit() {
        const l = await db.jurnal.toArray(); if(!l.length) return alert("Gol");
        XLSX.writeFile(XLSX.utils.book_new(), "Jurnal.xlsx"); // Placeholder simplificat
        const ws = XLSX.utils.json_to_sheet(l); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Jurnal"); XLSX.writeFile(wb, "Jurnal_Audit.xlsx");
    }

    function doBackup() { db.produse.toArray().then(a => { const b = new Blob([JSON.stringify(a)], {type: "application/json"}); const u = URL.createObjectURL(b); const l = document.createElement('a'); l.href=u; l.download="backup.json"; l.click(); }); }
    async function restoreBackup(e) { const r = new FileReader(); r.onload = async (ev) => { await db.produse.clear(); await db.produse.bulkAdd(JSON.parse(ev.target.result)); render(); alert("Restaurat!"); }; r.readAsText(e.target.files[0]); }

    // Service Worker Register
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered'))
                .catch(err => console.log('SW Error:', err));
        });
    }

    render();
</script>
</body>
</html>

